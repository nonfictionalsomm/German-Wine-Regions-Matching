<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Wine Regions Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #F8F8F6; /* Off-white, like a dry Riesling */
            color: #4A4A4A; /* Slate gray text */
        }
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }
        .game-card {
            background-color: #FFFFFF;
            border: 1px solid #EAEAE8;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        }
        .btn-choice {
            transition: all 0.2s ease-in-out;
            border: 2px solid #EAEAE8;
            background-color: #fff;
            min-height: 4rem; /* Ensures parallel alignment */
            display: flex;
            align-items: center;
            justify-content: center; /* Center text */
            text-align: center;
            padding: 0.75rem;
        }
        .btn-choice:hover:not(:disabled) {
            background-color: #F8F8F6;
            transform: translateY(-2px);
        }
        .btn-choice.selected {
            background-color: #E0E7FF; /* Light blue for selected */
            border-color: #A5B4FC;
        }
        .btn-choice.correct {
            background-color: #E6F3E6; /* Soft Green */
            border-color: #A3C9A3;
            color: #3B7A3B;
            cursor: default;
        }
        .btn-choice.incorrect {
            animation: shake 0.5s;
            background-color: #FBE6E6; /* Soft Red */
            border-color: #E99999;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .modal-backdrop {
            background-color: rgba(40, 40, 30, 0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .btn-primary {
             background-color: #BDA672; /* Riesling gold */
             color: white;
        }
        .btn-primary:hover {
            background-color: #AC9662;
        }
        .btn-secondary {
            background-color: #708090; /* Slate Gray */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6875;
        }
        .theme-text { color: #BDA672; }
        .theme-bg-light { background-color: rgba(189, 166, 114, 0.05); }
        .theme-border-light { border-color: rgba(189, 166, 114, 0.1); }
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #F8F8F6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 md:p-4">

    <div id="main-menu-container" class="w-full max-w-2xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full text-center transform transition-all">
            <h2 class="text-4xl font-bold mb-4 theme-text">German Wine Regions Challenge</h2>
            <p class="text-lg mb-6 text-gray-700">Test your knowledge of Germany's wine geography.</p>
            
            <div class="space-y-4 mb-6">
                <button id="play-bereiche-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors text-lg">Bereiche Study</button>
                <button id="play-grosslage-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors text-lg">Grosslagen Challenge</button>
                <button id="play-villages-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors text-lg">Major Villages Challenge</button>
                <button id="play-moguls-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors text-lg">Moguls Challenge</button>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button id="view-database-btn" class="w-1/2 bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors text-xl">View Database</button>
                <button id="rules-btn" class="w-1/2 bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors text-xl">Rules</button>
            </div>
        </div>
    </div>
    
    <div id="database-container" class="w-full max-w-6xl mx-auto hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold theme-text">German Wine Database</h2>
                <button id="back-to-menu-db-btn" class="btn-primary font-bold py-2 px-4 rounded-lg transition-colors">Main Menu</button>
            </div>
            <div class="table-container border theme-border-light rounded-lg">
                <table class="w-full text-left">
                    <thead class="border-b theme-border-light">
                        <tr>
                            <th class="p-4">Anbaugebiet</th>
                            <th class="p-4">Bereiche</th>
                            <th class="p-4">Grosslage</th>
                            <th class="p-4">Village</th>
                            <th class="p-4">Mogul</th>
                        </tr>
                    </thead>
                    <tbody id="database-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="game-container" class="w-full max-w-4xl mx-auto hidden relative pb-16">
        <button id="back-to-menu-game-btn" class="absolute bottom-0 right-0 mb-2 mr-2 md:mb-0 md:mr-0 btn-secondary font-bold py-2 px-4 rounded-lg transition-colors z-10 text-xs md:text-base">Main Menu</button>
        <div class="text-center mb-6">
            <h1 id="game-title" class="text-4xl md:text-5xl font-bold theme-text"></h1>
        </div>

        <div class="flex justify-around items-center mb-6 p-4 rounded-lg theme-bg-light game-card">
            <div class="text-center">
                <h3 class="text-xl font-bold">Round</h3>
                <p id="round-info" class="text-2xl font-semibold">1 / 10</p>
            </div>
            <div class="text-center">
                <h3 class="text-xl font-bold">Score</h3>
                <p id="score-info" class="text-2xl font-semibold">0</p>
            </div>
        </div>

        <div class="game-card rounded-lg p-4 md:p-8">
            <div class="grid grid-cols-2 gap-3 md:gap-8">
                <div>
                    <h3 id="left-column-title" class="text-xl md:text-2xl font-bold text-center mb-4"></h3>
                    <div id="left-column-container" class="flex flex-col space-y-3"></div>
                </div>
                <div>
                    <h3 id="right-column-title" class="text-xl md:text-2xl font-bold text-center mb-4"></h3>
                    <div id="right-column-container" class="flex flex-col space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="round-over-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full text-center modal-content">
             <h2 id="feedback-message" class="text-4xl font-bold mb-4 theme-text"></h2>
             <div class="mb-6 text-left max-h-60 overflow-y-auto" id="success-info">
                 </div>
            <button id="next-round-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors">Continue</button>
        </div>
    </div>

    <div id="rules-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-left modal-content">
             <h2 class="text-3xl font-bold mb-4 theme-text">Game Modes & Rules</h2>
             <div class="space-y-4 text-gray-700">
                 <div>
                     <h3 class="font-bold">Bereiche Study:</h3>
                     <p class="text-sm">Match the <span class="font-semibold">Bereiche</span> (District) to its correct <span class="font-semibold">Anbaugebiet</span> (Region).</p>
                 </div>
                 <div>
                     <h3 class="font-bold">Grosslagen Challenge:</h3>
                     <p class="text-sm">Match the <span class="font-semibold">Grosslage</span> (Collective Vineyard Site) to its correct <span class="font-semibold">Bereiche</span> (District).</p>
                 </div>
                 <div>
                     <h3 class="font-bold">Major Villages Challenge:</h3>
                     <p class="text-sm">Match the <span class="font-semibold">Major Village</span> to its correct <span class="font-semibold">Bereiche</span> (District).</p>
                 </div>
                 <div>
                     <h3 class="font-bold">Moguls Challenge:</h3>
                     <p class="text-sm">Match the <span class="font-semibold">Mogul</span> (Top Producer) to their home <span class="font-semibold">Village</span>.</p>
                 </div>
                 <hr>
                 <p class="text-sm">All modes consist of 10 rounds, with 5 matches per round. You get +2 points for a correct match on your first try, +1 for a correct match on subsequent tries, and -1 for an incorrect guess.</p>
             </div>
            <button id="close-rules-btn" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg transition-colors mt-6">Close</button>
        </div>
    </div>
    
    <div id="game-over-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center modal-content">
            <h2 class="text-4xl font-bold mb-4 theme-text">Game Over!</h2>
            <p id="final-feedback" class="text-xl mb-4"></p>
            <div class="theme-bg-light p-4 rounded-lg mb-6">
                <p class="text-lg text-left clear-both">Final Score: <span id="final-score" class="font-bold float-right">0</span></p>
                <p class="text-lg text-left mt-1 clear-both">Accuracy: <span id="final-percentage" class="font-bold float-right">0%</span></p>
            </div>
            <button id="play-again-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg transition-colors mb-3">Play Again</button>
            <button id="game-over-main-menu-btn" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg transition-colors">Main Menu</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const gameData = {
            "german_wine_regions": [
                {
                    "anbaugebiet": "Ahr",
                    "bereiche": ["Walporzheim-Ahrtal"],
                    "grosslagen": { "Walporzheim-Ahrtal": ["Klosterberg"] },
                    "major_villages": [{ "bereiche": "Walporzheim-Ahrtal", "villages": ["Altenahr", "Mayschoss", "Rech", "Dernau", "Marienthal", "Walporzheim", "Ahrweiler", "Bad-Neuenahr", "Heppingen", "Heimersheim"] }],
                    "mogul": [{ "name": "Meyer-Näkel", "village": "Dernau" }, { "name": "Kreuzberg", "village": "Dernau" }, { "name": "Nelles", "village": "Bad Neuenahr" }, { "name": "Jean Stodden", "village": "Rech" }, { "name": "Weingut Deutzerhof - Cossmann-Hehle", "village": "Mayschoss" }, { "name": "J.J. Adeneuer", "village": "Ahrweiler" }]
                },
                {
                    "anbaugebiet": "Baden",
                    "bereiche": ["Badische-Bergstrasse", "Kraichgau", "Ortenau", "Breisgau", "Kaiserstuhl", "Markgräflerland", "Bodensee", "Tauberfranken", "Tuniberg"],
                    "grosslagen": { "Badische Bergstrasse": ["Rittersberg", "Mannaberg"], "Kraichgau": ["Stiftsberg", "Hohenberg", "Mannaberg"], "Ortenau": ["Schloss Rodeck", "Fürsteneck"], "Breisgau": ["Burg Lichteneck", "Burg Zähringen", "Schutterlindenberg"], "Kaiserstuhl": ["Vulkanfelsen"], "Markgräflerland": ["Lorettoberg", "Burg Neuenfels", "Vogtei Rötteln"], "Bodensee": ["Sonnenufer"], "Tauberfranken": ["Tauberklinge"], "Tuniberg": ["Attilafelsen"] },
                    "major_villages": [{ "bereiche": "Badische-Bergstrasse", "villages": ["Heidelberg", "Leimen"] }, { "bereiche": "Kraichgau", "villages": ["Östringen", "Sulzfeld", "Tiefenbach"] }, { "bereiche": "Ortenau", "villages": ["Baden-Baden", "Varnhalt", "Neuweier", "Sasbachwalden", "Durbach", "Zell-Weierbach"] }, { "bereiche": "Breisgau", "villages": ["Freiburg", "Malterdingen", "Emmendingen", "Lahr", "Hecklingen"] }, { "bereiche": "Kaiserstuhl", "villages": ["Achkarren", "Burkheim", "Oberrotweil", "Ihringen", "Sasbach"] }, { "bereiche": "Markgräflerland", "villages": ["Schliengen", "Istein", "Mauchen", "Auggen"] }, { "bereiche": "Bodensee", "villages": ["Meersburg"] }],
                    "mogul": [{ "name": "Bernhard Huber", "village": "Malterdingen" }, { "name": "Andreas Laible", "village": "Durbach" }, { "name": "R. and C. Schneider", "village": "Endingen" }, { "name": "Salwey", "village": "Oberrotweil" }, { "name": "Dr. Heger", "village": "Ihringen" }, { "name": "Enderle & Moll", "village": "Münchweier" }]
                },
                {
                    "anbaugebiet": "Franken",
                    "bereiche": ["Mainviereck", "Maindreieck", "Steigerwald"],
                    "grosslagen": { "Mainviereck": ["Heiligenthal", "Reuschberg"], "Maindreieck": ["Burg", "Engelsberg", "Ewig Leben", "Hofrat", "Honigberg", "Kirchberg", "Marienberg", "Markgraf Babenberg", "Ölspiel", "Ravensburg", "Rosstal", "Teufelstor"], "Steigerwald": ["Schild", "Zabelstein", "Schlossstück", "Herrenberg", "Burgberg", "Schlossberg", "Steige", "Burgweg", "Kapellenberg"] },
                    "major_villages": [{ "bereiche": "Mainviereck", "villages": ["Bürgstadt", "Miltenberg", "Marktheidenfeld", "Erlenbach"] }, { "bereiche": "Maindreieck", "villages": ["Karlstadt", "Thüngersheim", "Würzburg", "Randersacker", "Sommerhausen", "Frickenhausen", "Escherndorf", "Volkach", "Nordheim", "Fahr"] }, { "bereiche": "Steigerwald", "villages": ["Rödelsee", "Iphofen", "Castell", "Wiesenbronn"] }],
                    "mogul": [{ "name": "Rudolf Fürst", "village": "Bürgstadt" }, { "name": "Horst Sauer", "village": "Escherndorf" }, { "name": "Hans Wirsching", "village": "Iphofen" }, { "name": "Juliusspital Würzburg", "village": "Würzburg" }, { "name": "Castell'sches Domänenamt", "village": "Castell" }]
                },
                {
                    "anbaugebiet": "Hessische-Bergstrasse",
                    "bereiche": ["Starkenburg", "Umstadt"],
                    "grosslagen": { "Starkenburg": ["Rott", "Wolfsmagen", "Schlossberg"], "Umstadt": [] },
                    "major_villages": [{ "bereiche": "Starkenburg", "villages": ["Zwingenberg", "Auerbach", "Bensheim", "Heppenheim"] }],
                    "mogul": [{ "name": "Hessische Staatsweingüter Domaine Bergstrasse", "village": "Bensheim" }, { "name": "Simon-Bürkle", "village": "Zwingenberg" }]
                },
                {
                    "anbaugebiet": "Mittlerhein",
                    "bereiche": ["Loreley", "Siebengebirge"],
                    "grosslagen": { "Loreley": ["Burg Hammerstein", "Marksburg", "Gedeonseck", "Schloss Schönburg", "Herrenberg", "Schloss Stahleck", "Loreleyfelsen", "Schloss Reichenstein", "Lahntal", "Burg Rheinfels"], "Siebengebirge": ["Petersberg"] },
                    "major_villages": [{ "bereiche": "Loreley", "villages": ["Bad Hönningen", "Hammerstein", "Leubsdorf", "Spay", "Osterspai", "Boppard", "Oberwesel", "Engehöll", "Dörscheid", "Dellhofen", "Bacharach", "Steeg"] }],
                    "mogul": [{ "name": "Matthias Müller", "village": "Spay" }, { "name": "Ratzenberger", "village": "Bacharach" }, { "name": "Toni Jost-Hahnenhof", "village": "Bacharach" }, { "name": "Frederich Bastian", "village": "Bacharach" }, { "name": "Lanius Knab", "village": "Oberwesel" }]
                },
                {
                    "anbaugebiet": "Mosel",
                    "bereiche": ["Burg Cochem", "Bernkastel", "Ruwertal", "Saar", "Moseltor", "Obermosel"],
                    "grosslagen": { "Burg Cochem": ["Weinhex", "Goldbäumchen", "Grafschaft", "Rosenhang", "Schwarze Katz"], "Bernkastel": ["Vom heissen Stein", "Schwarzlay", "Nacktarsch", "Münzlay", "Kurfürstenlay", "Michelsberg", "St. Michael", "Badstube", "Propstberg", "Römerlay"], "Ruwertal": ["Grosslagenfrei", "Römerlay"], "Saar": ["Scharzberg"], "Moseltor": ["Schloss Bübingen"], "Obermosel": ["Gipfel", "Königsberg"] },
                    "major_villages": [{ "bereiche": "Burg Cochem", "villages": ["Winningen", "Kobern-Gondorf", "Hatzenport", "Cochem", "Bremm", "Zell"] }, { "bereiche": "Bernkastel", "villages": ["Pünderich", "Enkirch", "Traben-Trarbach", "Wolf", "Kröv", "Lösnich", "Erden", "Ürzig", "Zeltingen", "Wehlen", "Graach an der Mosel", "Bernkastel-Kues", "Lieser", "Brauneberg", "Kesten", "Wintrich", "Piesport", "Dhron", "Neumagen", "Trittenheim", "Leiwen"] }, { "bereiche": "Ruwertal", "villages": ["Ruwer", "Eitelsbach", "Mertesdorf", "Kasel", "Waldrach", "Avelsbach"] }, { "bereiche": "Saar", "villages": ["Serrig", "Saarburg", "Wiltingen", "Ockfen", "Oberemmel", "Kanzem"] }],
                    "mogul": [{ "name": "Fritz Haag", "village": "Brauneberg" }, { "name": "Dr. Loosen", "village": "Bernkastel-Kues" }, { "name": "Egon Müller", "village": "Wiltingen" }, { "name": "Joh. Jos. Prüm", "village": "Wehlen" }, { "name": "Karthäuserhof", "village": "Eitelsbach" }]
                },
                {
                    "anbaugebiet": "Nahe",
                    "bereiche": ["Nahetal"],
                    "grosslagen": { "Nahetal": ["Schlosskapelle", "Pfarrgarten", "Kronenberg", "Burgweg", "Paradiesgarten", "Rosengarten", "Sonnenborn"] },
                    "major_villages": [{ "bereiche": "Nahetal", "villages": ["Münster-Sarmsheim", "Burg Layen", "Dorsheim", "Laubenheim", "Windesheim", "Langenlonsheim", "Wallhausen", "Bad Kreuznach", "Bad Münster am Stein", "Traisen", "Norheim", "Niederhausen", "Oberhausen", "Schlossböckelheim", "Bockenau", "Monzingen"] }],
                    "mogul": [{ "name": "Hermann Dönnhoff", "village": "Oberhausen" }, { "name": "Emrich-Schönleber", "village": "Monzingen" }, { "name": "Schlossgut Diel", "village": "Burg Layen" }, { "name": "Schäfer-Fröhlich", "village": "Bockenau" }, { "name": "Dr. Crusius", "village": "Traisen" }]
                },
                {
                    "anbaugebiet": "Pfalz",
                    "bereiche": ["Mittelhaardt-Deutsche Weinstrasse", "Südliche Weinstrasse"],
                    "grosslagen": { "Mittelhaardt-Deutsche Weinstrasse": ["Höllenpfad", "Schwarzerde", "Feuerberg", "Grafenstück", "Kobnert", "Hofstück", "Mariengarten", "Pfaffengrund", "Rebstöckel", "Hochmess", "Schenkenböhl", "Rosenböhl", "Meerspinne", "Honigsäckel"], "Südliche Weinstrasse": ["Bischofskreuz", "Königsgarten", "Mandelhöhe", "Trappenberg", "Kloster Liebfrauenberg", "Guttenberg", "Schloss Ludwigshöhle", "Ordensgut", "Herrlich"] },
                    "major_villages": [{ "bereiche": "Mittelhaardt-Deutsche Weinstrasse", "villages": ["Dirmstein", "Grünstadt", "Laumersheim", "Grosskarlbach", "Kirchheim", "Weisenheim", "Kallstadt", "Ungstein", "Bad Dürkheim", "Wachenheim", "Forst", "Deidesheim", "Ruppertsberg", "Gimmeldingen", "Mussbach", "Haardt", "Neustadt", "Duttweiler"] }, { "bereiche": "Südliche Weinstrasse", "villages": ["Hainfeld", "Burrweiler", "Gleisweiler", "Essingen", "Siebeldingen", "Birkweiler", "Klingenmünster", "Schweigen"] }],
                    "mogul": [{ "name": "Knipser", "village": "Laumersheim" }, { "name": "Ökonomierat Rebholz", "village": "Siebeldingen" }, { "name": "Bassermann-Jordan", "village": "Deidesheim" }, { "name": "Von Winning", "village": "Deidesheim" }, { "name": "Friedrich Becker", "village": "Schweigen" }, { "name": "Dr. Bürklin-Wolf", "village": "Wachenheim" }, { "name": "A. Christmann", "village": "Gimmeldingen" }, { "name": "Koehler-Ruprecht", "village": "Kallstadt" }, { "name": "Philipp Kuhn", "village": "Laumersheim" }, { "name": "Georg Mosbacher", "village": "Forst" }, { "name": "Pfeffingen - Fuhrmann-Eymael", "village": "Bad Dürkheim" }, { "name": "Dr. Wehrheim", "village": "Birkweiler" }]
                },
                {
                    "anbaugebiet": "Rheingau",
                    "bereiche": ["Johannisberg"],
                    "grosslagen": { "Johannisberg": ["Burgweg", "Daubhaus", "Deutelsberg", "Erntebringer", "Gottesthal", "Heiligenstock", "Honigberg", "Mehrhölzchen", "Steil", "Steinmächer"] },
                    "major_villages": [{ "bereiche": "Johannisberg", "villages": ["Lorch", "Assmannshausen", "Rüdesheim", "Geisenheim", "Johannisberg", "Winkel", "Oestrich", "Hallgarten", "Hattenheim", "Erbach", "Kiedrich", "Eltville", "Rauenthal", "Martinsthal", "Walluf", "Hochheim", "Wicker"] }],
                    "mogul": [{ "name": "Robert Weil", "village": "Kiedrich" }, { "name": "Georg Breuer", "village": "Rüdesheim" }, { "name": "Schloss Johannisberg", "village": "Geisenheim" }, { "name": "August Kesseler", "village": "Assmannshausen" }, { "name": "Franz Künstler", "village": "Hochheim" }, { "name": "Josef Leitz", "village": "Rüdesheim" }, { "name": "Schloss Schönborn", "village": "Hattenheim" }, { "name": "Josef Spreitzer", "village": "Oestrich" }]
                },
                {
                    "anbaugebiet": "Rheinhessen",
                    "bereiche": ["Nierstein", "Bingen", "Wonnegau"],
                    "grosslagen": { "Nierstein": ["Auflangen", "Domherr", "Güldenmorgen", "Gutes Domtal", "Krötenbrunnen", "Petersberg", "Rehbach", "Rheinblick", "Sankt Alban", "Spiegelberg", "Vögelsgärten"], "Bingen": ["Adelberg", "Kaiserpfalz", "Kurfürstensück", "Rheingrafenstein", "Sankt Rochuskapelle", "Abtey"], "Wonnegau": ["Bergkloster", "Burg Rodenstein", "Domblick", "Gotteshilfe", "Liebfrauenmorgen", "Pilgerpfad", "Sybillenstein"] },
                    "major_villages": [{ "bereiche": "Nierstein", "villages": ["Bodenheim", "Nackenheim", "Nierstein", "Oppenheim", "Dienheim"] }, { "bereiche": "Bingen", "villages": ["Siefersheim", "Bingen", "Appenheim"] }, { "bereiche": "Wonnegau", "villages": ["Westhofen", "Flörsheim-Dalsheim", "Dittelsheim", "Monsheim", "Worms"] }],
                    "mogul": [{ "name": "Keller", "village": "Flörsheim-Dalsheim" }, { "name": "Kühling-Gillot", "village": "Bodenheim" }, { "name": "Wagner-Stempel", "village": "Siefersheim" }, { "name": "Wittman", "village": "Westhofen" }, { "name": "Gunderloch", "village": "Nackenheim" }]
                },
                {
                    "anbaugebiet": "Saale-Unstrut",
                    "bereiche": ["Schloss Neuenburg", "Thüringen", "Mansfelder Seen"],
                    "grosslagen": { "Schloss Neuenburg": ["Schweigenberg", "Blütengrund", "Göttersitz"], "Thüringen": [], "Mansfelder Seen": ["Kelterberg"] },
                    "major_villages": [{ "bereiche": "Schloss Neuenburg", "villages": ["Bad Kösen", "Freyburg", "Weischütz", "Karsdorf", "Naumburg"] }],
                    "mogul": [{ "name": "Pawis", "village": "Freyburg" }]
                },
                {
                    "anbaugebiet": "Sachsen",
                    "bereiche": ["Meissen", "Elstertal"],
                    "grosslagen": { "Meissen": ["Spaargebirge", "Schlossweinberg", "Elbhänge", "Lössnitz"], "Elstertal": [] },
                    "major_villages": [{ "bereiche": "Meissen", "villages": ["Seusslitz", "Proschwitz", "Meissen", "Pillnitz", "Radebeul", "Dresden-Pillnitz"] }],
                    "mogul": [{ "name": "Schloss Proschwitz", "village": "Meissen" }, { "name": "Klaus Zimmerling", "village": "Dresden-Pillnitz" }]
                },
                {
                    "anbaugebiet": "Württemberg",
                    "bereiche": ["Remstal-Stuttgart", "Württembergisch Unterland", "Württembergisch Bodensee", "Bayerischer Bodensee", "Kocher-Jagst-Tauber", "Oberer Neckar"],
                    "grosslagen": { "Remstal-Stuttgart": ["Hohenneuffen", "Kopf", "Sonnenbühl", "Wartbühl", "Weinsteige"], "Württembergisch Unterland": ["Heuchelberg", "Kirchenweinberg", "Lindelberg", "Salzberg", "Schalkstein", "Schozachtal", "Staufenberg", "Stromberg", "Wunnenstein"], "Württembergisch Bodensee": [], "Bayerischer Bodensee": ["Seegarten"], "Kocher-Jagst-Tauber": ["Kocherberg"], "Oberer Neckar": [] },
                    "major_villages": [{ "bereiche": "Remstal-Stuttgart", "villages": ["Stetten", "Schnait", "Fellbach", "Untertürkheim", "Winterbach", "Kernen"] }, { "bereiche": "Württembergisch Unterland", "villages": ["Stetten", "Schozach", "Neipperg", "Schwaigern", "Kleinbottwar", "Hohenbeilstein", "Neckarsulm", "Heilbronn", "Gundelsheim", "Besigheim", "Mundelsheim", "Bönnigheim", "Verrenberg", "Maulbronn", "Weinsberg"] }],
                    "mogul": [{ "name": "Gerhard Aldinger", "village": "Fellbach" }, { "name": "Rainer Schnaitmann", "village": "Fellbach" }, { "name": "Karl Haidle", "village": "Kernen" }]
                }
            ]
        };

        const TOTAL_ROUNDS = 10;
        
        // --- GAME STATE ---
        let totalScore = 0;
        let currentRound = 1;
        let roundData = [];
        let score = 0;
        let correctMatches = 0;
        let selectedLeftItem = null;
        let selectedRightItem = null;
        let roundAttempts = {}; 
        let currentGameMode = ''; // 'bereiche', 'grosslage', 'villages', 'moguls'

        // --- DOM ELEMENTS ---
        const mainMenuContainer = document.getElementById('main-menu-container');
        const gameContainer = document.getElementById('game-container');
        const databaseContainer = document.getElementById('database-container');
        
        const roundInfo = document.getElementById('round-info');
        const scoreInfo = document.getElementById('score-info');
        const leftColumnContainer = document.getElementById('left-column-container');
        const rightColumnContainer = document.getElementById('right-column-container');
        const leftColumnTitle = document.getElementById('left-column-title');
        const rightColumnTitle = document.getElementById('right-column-title');

        const roundOverModal = document.getElementById('round-over-modal');
        const rulesModal = document.getElementById('rules-modal');
        const gameOverModal = document.getElementById('game-over-modal');

        // --- FUNCTIONS ---

        function showScreen(screen) {
            [mainMenuContainer, gameContainer, databaseContainer].forEach(el => el.classList.add('hidden'));
            if (screen === 'game') gameContainer.classList.remove('hidden');
            else if (screen === 'databaseView') databaseContainer.classList.remove('hidden');
            else mainMenuContainer.classList.remove('hidden');
        }

        function showModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                modal.firstElementChild.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function hideModal(modal, callback) {
            modal.firstElementChild.classList.remove('scale-100', 'opacity-100');
            modal.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                if (callback) callback();
            }, 200);
        }

        function populateDatabase() {
            const tableBody = document.getElementById('database-table-body');
            tableBody.innerHTML = ''; // Clear existing data

            gameData.german_wine_regions.forEach(region => {
                const row = document.createElement('tr');
                row.className = 'border-b theme-border-light';

                const formatArray = (arr) => arr ? arr.join('<br>') : 'N/A';
                const formatObject = (obj) => Object.entries(obj).map(([key, value]) => `<b>${key}:</b><br>${value.join('<br>') || 'N/A'}`).join('<hr class="my-2">');
                const formatNestedArray = (arr, key1, key2) => arr.map(item => `<b>${item[key1]}:</b><br>${Array.isArray(item[key2]) ? item[key2].join('<br>') : item[key2]}`).join('<hr class="my-2">');

                row.innerHTML = `
                    <td class="p-4 align-top">${region.anbaugebiet}</td>
                    <td class="p-4 align-top">${formatArray(region.bereiche)}</td>
                    <td class="p-4 align-top">${formatObject(region.grosslagen)}</td>
                    <td class="p-4 align-top">${formatNestedArray(region.major_villages, 'bereiche', 'villages')}</td>
                    <td class="p-4 align-top">${formatNestedArray(region.mogul, 'name', 'village')}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initGame(mode) {
            currentGameMode = mode;
            score = 0;
            totalScore = 0;
            currentRound = 1;
            document.getElementById('game-title').textContent = getGameTitle(mode);
            showScreen('game');
            startRound();
        }

        function getGameTitle(mode) {
            if (mode === 'bereiche') return "Bereiche Study";
            if (mode === 'grosslage') return "Grosslagen Challenge";
            if (mode === 'villages') return "Major Villages Challenge";
            if (mode === 'moguls') return "Moguls Challenge";
            return "German Wine Challenge";
        }
        
        function startRound() {
            if (currentRound > TOTAL_ROUNDS) {
                showGameOver();
                return;
            }
            
            roundData = [];
            correctMatches = 0;
            selectedLeftItem = null;
            selectedRightItem = null;
            roundAttempts = {};
            
            generateRoundData();
            
            updateScoreboard();
            renderButtons();
        }
        
        function generateRoundData() {
            const allPairs = [];
            const regions = gameData.german_wine_regions;

            if (currentGameMode === 'bereiche') {
                regions.forEach(region => {
                    region.bereiche.forEach(bereich => allPairs.push({ left: bereich, right: region.anbaugebiet }));
                });
                leftColumnTitle.textContent = 'Bereiche';
                rightColumnTitle.textContent = 'Anbaugebiet';
            } else if (currentGameMode === 'grosslage') {
                regions.forEach(region => {
                    for (const bereich in region.grosslagen) {
                        region.grosslagen[bereich].forEach(grosslage => allPairs.push({ left: grosslage, right: bereich }));
                    }
                });
                leftColumnTitle.textContent = 'Grosslage';
                rightColumnTitle.textContent = 'Bereiche';
            } else if (currentGameMode === 'villages') {
                regions.forEach(region => {
                    region.major_villages.forEach(item => {
                        item.villages.forEach(village => allPairs.push({ left: village, right: item.bereiche }));
                    });
                });
                leftColumnTitle.textContent = 'Major Village';
                rightColumnTitle.textContent = 'Bereiche';
            } else if (currentGameMode === 'moguls') {
                regions.forEach(region => {
                    region.mogul.forEach(producer => allPairs.push({ left: producer.name, right: producer.village }));
                });
                leftColumnTitle.textContent = 'Mogul';
                rightColumnTitle.textContent = 'Village';
            }

            shuffleArray(allPairs);
            roundData = allPairs.slice(0, 5);
        }
        
        function renderButtons() {
            leftColumnContainer.innerHTML = '';
            rightColumnContainer.innerHTML = '';

            const leftItems = shuffleArray(roundData.map(item => item.left));
            const rightItems = shuffleArray(roundData.map(item => item.right));

            const createButton = (item, type, container) => {
                const button = document.createElement('button');
                button.className = 'btn-choice p-2 rounded-lg text-sm md:text-base';
                button.textContent = item;
                button.dataset.value = item;
                button.addEventListener('click', () => handleSelection(type, button));
                container.appendChild(button);
            };

            leftItems.forEach(item => createButton(item, 'left', leftColumnContainer));
            rightItems.forEach(item => createButton(item, 'right', rightColumnContainer));
        }
        
        function handleSelection(type, button) {
             if (button.classList.contains('correct') || button.disabled) return;

             if (type === 'left') {
                 if (selectedLeftItem) selectedLeftItem.classList.remove('selected');
                 selectedLeftItem = button;
                 button.classList.add('selected');
             } else { // right
                 if (selectedRightItem) selectedRightItem.classList.remove('selected');
                 selectedRightItem = button;
                 button.classList.add('selected');
             }
             
             if (selectedLeftItem && selectedRightItem) {
                checkMatch();
             }
        }

        function checkMatch() {
            const leftValue = selectedLeftItem.dataset.value;
            const rightValue = selectedRightItem.dataset.value;
            const correctPair = roundData.find(item => item.left === leftValue);
            const isCorrect = correctPair && correctPair.right === rightValue;
            
            const tempLeft = selectedLeftItem;
            const tempRight = selectedRightItem;
            selectedLeftItem = null;
            selectedRightItem = null;

            if (isCorrect) {
                tempLeft.classList.remove('selected');
                tempRight.classList.remove('selected');
                tempLeft.classList.add('correct');
                tempRight.classList.add('correct');
                tempLeft.disabled = true;
                tempRight.disabled = true;

                score += roundAttempts[leftValue] ? 1 : 2;
                roundAttempts[leftValue] = true;

                correctMatches++;
                updateScoreboard();

                if (correctMatches === 5) {
                    setTimeout(showRoundOverModal, 500);
                }
            } else {
                score -= 1;
                updateScoreboard();
                roundAttempts[leftValue] = true;
                tempLeft.classList.add('incorrect');
                tempRight.classList.add('incorrect');
                
                setTimeout(() => {
                    tempLeft.classList.remove('incorrect', 'selected');
                    tempRight.classList.remove('incorrect', 'selected');
                }, 500);
            }
        }
        
        function showRoundOverModal() {
            totalScore += score;
            const feedbackMessage = document.getElementById('feedback-message');
            const successInfo = document.getElementById('success-info');
            
            feedbackMessage.textContent = `Round ${currentRound} Complete!`;
            
            let infoHTML = `<p class="font-bold text-lg mb-2">Correct Pairings:</p><ul class="list-disc pl-5 space-y-1">`;
            roundData.forEach(pair => {
                infoHTML += `<li><span class="font-semibold">${pair.left}</span> &rarr; <span class="font-semibold">${pair.right}</span></li>`;
            });
            infoHTML += '</ul>';
            successInfo.innerHTML = infoHTML;
            
            showModal(roundOverModal);
        }

        function hideRoundOverModal() {
            hideModal(roundOverModal, () => {
                currentRound++;
                score = 0;
                startRound();
            });
        }

        function updateScoreboard() {
            scoreInfo.textContent = score;
            roundInfo.textContent = `${Math.min(currentRound, TOTAL_ROUNDS)} / ${TOTAL_ROUNDS}`;
        }

        function showGameOver() {
            const finalScoreEl = document.getElementById('final-score');
            const finalPercentageEl = document.getElementById('final-percentage');
            const finalFeedback = document.getElementById('final-feedback');
            
            const maxScore = TOTAL_ROUNDS * 5 * 2;
            const percentage = maxScore > 0 ? Math.round(Math.max(0, (totalScore / maxScore) * 100)) : 0;
            
            finalScoreEl.textContent = totalScore;
            finalPercentageEl.textContent = `${percentage}%`;

            if(percentage === 100) finalFeedback.textContent = "Perfect Score! Incredible!";
            else if (percentage >= 80) finalFeedback.textContent = "Excellent work! You're a true connoisseur.";
            else if (percentage >= 60) finalFeedback.textContent = "Great job! You know your stuff.";
            else finalFeedback.textContent = "Good effort! Keep studying and you'll be an expert.";

            showModal(gameOverModal);
        }
        
        function hideGameOverAndReset() {
             hideModal(gameOverModal, () => initGame(currentGameMode));
        }
        
        function hideGameOverAndMenu() {
            hideModal(gameOverModal, () => showScreen('main'));
        }

        // --- EVENT LISTENERS ---
        document.getElementById('play-bereiche-btn').addEventListener('click', () => initGame('bereiche'));
        document.getElementById('play-grosslage-btn').addEventListener('click', () => initGame('grosslage'));
        document.getElementById('play-villages-btn').addEventListener('click', () => initGame('villages'));
        document.getElementById('play-moguls-btn').addEventListener('click', () => initGame('moguls'));
        
        document.getElementById('view-database-btn').addEventListener('click', () => {
            populateDatabase();
            showScreen('databaseView');
        });
        document.getElementById('back-to-menu-db-btn').addEventListener('click', () => showScreen('main'));
        
        document.getElementById('rules-btn').addEventListener('click', () => showModal(rulesModal));
        document.getElementById('close-rules-btn').addEventListener('click', () => hideModal(rulesModal));
        
        document.getElementById('back-to-menu-game-btn').addEventListener('click', () => showScreen('main'));
        document.getElementById('next-round-btn').addEventListener('click', hideRoundOverModal);
        document.getElementById('play-again-btn').addEventListener('click', hideGameOverAndReset);
        document.getElementById('game-over-main-menu-btn').addEventListener('click', hideGameOverAndMenu);
        
        // --- INITIALIZATION ---
        showScreen('main');
    </script>
</body>
</html>
